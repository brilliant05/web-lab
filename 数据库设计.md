# 大学生线上学习资源共享与问答系统 - 数据库设计文档

## 一、数据库概述

### 1.1 数据库信息
- **数据库名称**: `learning_system`
- **数据库引擎**: InnoDB
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **数据库版本**: MySQL 8.0+

### 1.2 设计原则
- 表名使用小写字母,单词之间用下划线分隔
- 字段名见名知意,使用下划线命名法
- 所有表必须有主键,推荐使用自增ID
- 时间字段统一使用 `create_time`、`update_time`
- 逻辑删除字段使用 `is_deleted`
- 状态字段使用 `status`
- 外键关系通过字段命名体现(如 `user_id`、`course_id`)
- 合理使用索引提升查询性能

---

## 二、核心业务关系说明

### 2.1 用户与角色
- 用户表统一管理三种角色(管理员、教师、学生)
- 通过 `role` 字段区分角色类型
- 管理员由系统初始化创建
- 学生可自主注册
- 教师由管理员创建

### 2.2 课程与用户关系
- **教师-课程**: 多对多关系,一个教师可教授多门课程,一门课程可由多个教师教授
  - 中间表: `teacher_course`(教师授课关系表)
  - 每个"教师-课程"组合可生成独立的邀请码
  - 支持班级名称区分（如同一教师教授同一课程的不同班级）
  
- **学生-课程-教师**: 三元关系,明确学生跟随哪个教师上哪门课
  - 中间表: `student_course`(学生选课关系表)
  - **关键字段**: `teacher_id` 明确授课教师
  - 学生加入课程的方式:
    1. 管理员直接分配（需指定课程和教师）
    2. 使用教师提供的课程邀请码加入（自动关联到该教师）
  - 记录加入时间、加入方式
  - **业务场景**: 
    - 同一门课程由多个教师教授（不同班级、不同学期）
    - 学生只能看到自己授课教师的非公开资源
    - 支持学生换班、重修等场景（可跟随不同教师上同一课程）

### 2.3 资源可见性（基于教师维度）
- 资源表包含 `visibility` 字段,控制可见范围:
  - `PUBLIC`: 全部学生可见（跨教师、跨课程）
  - `COURSE_ONLY`: **仅跟随该教师上该课程的学生可见**
  - `CLASS_ONLY`: 仅指定班级可见(可选扩展)
  
- 资源访问控制逻辑（重点）:
  - **教师视角**: 可查看自己上传的所有资源
  - **学生视角**: 
    - ✅ 可查看所有 `PUBLIC` 资源
    - ✅ 可查看"自己授课教师"上传的 `COURSE_ONLY` 资源
    - ❌ **不能查看**同一课程"其他教师"上传的 `COURSE_ONLY` 资源
  - **管理员视角**: 可查看所有资源
  
- **示例场景**:
  - 课程: Java程序设计
  - 教师A: 上传了10个资源（5个PUBLIC, 5个COURSE_ONLY）
  - 教师B: 上传了8个资源（3个PUBLIC, 5个COURSE_ONLY）
  - 学生X: 跟随教师A上Java课
  - **学生X可见**: 教师A的全部10个资源 + 教师B的3个PUBLIC资源 = 13个资源
  - **学生X不可见**: 教师B的5个COURSE_ONLY资源

### 2.4 问答关系（开放式问答）
- **开放式提问**: 所有学生都可以向任何课程的任何教师提问，无需先选修该课程
- 学生向具体教师提问，问题关联到"课程+教师"
- **提问流程**: 
  - 学生选择课程 → 查看该课程的所有授课教师 → 选择具体教师提问
  - 无需验证学生是否选修该课程
- **回答权限**: 教师只能看到和回答向自己提问的问题
  - 查询条件: `question.teacher_id = 当前教师ID`
- **业务场景**:
  - 任何学生都可以向张老师提问Java相关问题（无论是否选修）
  - 学生可以跨课程、跨专业提问，促进知识共享
  - 张老师只能看到向他提的问题，看不到向李老师提的问题
- 一个问题由一个指定教师回答（问题指向的教师）

---

## 三、数据表设计

### 3.1 用户表 (user)
存储系统所有用户信息(管理员、教师、学生)

```sql
CREATE TABLE `user` (
  `user_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID,主键',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名,唯一',
  `password` VARCHAR(255) NOT NULL COMMENT '密码(BCrypt加密)',
  `real_name` VARCHAR(50) NOT NULL COMMENT '真实姓名',
  `email` VARCHAR(100) NOT NULL COMMENT '邮箱,唯一',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `avatar_url` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `role` VARCHAR(20) NOT NULL COMMENT '角色: ADMIN-管理员, TEACHER-教师, STUDENT-学生',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '账号状态: 0-禁用, 1-正常',
  `student_id` VARCHAR(30) DEFAULT NULL COMMENT '学号(仅学生有)',
  `college` VARCHAR(100) DEFAULT NULL COMMENT '所属学院(学生)',
  `job_title` VARCHAR(50) DEFAULT NULL COMMENT '职称(教师): 助教、讲师、副教授、教授',
  `profile` TEXT DEFAULT NULL COMMENT '个人简介',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_student_id` (`student_id`),
  KEY `idx_role` (`role`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

**字段说明**:
- `user_id`: 用户唯一标识
- `username`: 登录用户名
- `password`: BCrypt加密后的密码
- `role`: 角色类型,用于权限控制
- `student_id`: 学号,仅学生角色需要填写
- `college`: 学院信息,学生必填
- `job_title`: 教师职称
- `profile`: 个人简介,教师可填写教学经历等
- `is_deleted`: 软删除标记

---

### 3.2 课程表 (course)
存储课程基本信息

```sql
CREATE TABLE `course` (
  `course_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '课程ID,主键',
  `course_name` VARCHAR(100) NOT NULL COMMENT '课程名称',
  `course_code` VARCHAR(50) DEFAULT NULL COMMENT '课程编号',
  `description` TEXT DEFAULT NULL COMMENT '课程描述',
  `college` VARCHAR(100) DEFAULT NULL COMMENT '开课学院',
  `cover_image` VARCHAR(255) DEFAULT NULL COMMENT '课程封面图片URL',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '课程状态: 0-关闭, 1-开放',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`course_id`),
  UNIQUE KEY `uk_course_code` (`course_code`),
  KEY `idx_college` (`college`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='课程表';
```

**字段说明**:
- `course_id`: 课程唯一标识
- `course_name`: 课程名称
- `course_code`: 课程编号,如"CS101"
- `status`: 课程开放状态

**注意**: 邀请码功能移至 `teacher_course` 表，因为邀请码应该关联到具体的"教师-课程"组合

---

### 3.3 教师授课关系表 (teacher_course)
记录教师与课程的多对多关系，每个教师可为自己的课程生成邀请码

```sql
CREATE TABLE `teacher_course` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `teacher_id` BIGINT NOT NULL COMMENT '教师ID',
  `course_id` BIGINT NOT NULL COMMENT '课程ID',
  `invite_code` VARCHAR(20) DEFAULT NULL COMMENT '该教师为该课程生成的邀请码',
  `invite_code_expire_time` DATETIME DEFAULT NULL COMMENT '邀请码过期时间',
  `class_name` VARCHAR(100) DEFAULT NULL COMMENT '班级名称(可选),如"2024级1班"',
  `assign_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_teacher_course` (`teacher_id`, `course_id`),
  UNIQUE KEY `uk_invite_code` (`invite_code`),
  KEY `idx_teacher_id` (`teacher_id`),
  KEY `idx_course_id` (`course_id`),
  CONSTRAINT `fk_tc_teacher` FOREIGN KEY (`teacher_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_tc_course` FOREIGN KEY (`course_id`) REFERENCES `course` (`course_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='教师授课关系表';
```

**字段说明**:
- `teacher_id`: 教师用户ID
- `course_id`: 课程ID
- `invite_code`: **该教师为该课程生成的专属邀请码**，学生使用此码加入后自动关联到该教师
- `invite_code_expire_time`: 邀请码过期时间，教师可设置有效期
- `class_name`: 班级名称（可选），便于区分同一教师教授同一课程的不同班级
- `assign_time`: 管理员分配该课程给教师的时间
- 唯一约束确保一个教师不会重复关联同一课程
- 邀请码唯一性约束，避免不同教师生成相同邀请码

**业务说明**:
- 每个"教师-课程"组合可以有独立的邀请码
- 学生使用邀请码加入时，系统自动识别是哪个教师的课程
- 教师可随时刷新邀请码或设置新的过期时间

---

### 3.4 学生选课关系表 (student_course)
记录学生与课程的多对多关系，明确学生跟随哪个教师上课

```sql
CREATE TABLE `student_course` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `student_id` BIGINT NOT NULL COMMENT '学生ID',
  `course_id` BIGINT NOT NULL COMMENT '课程ID',
  `teacher_id` BIGINT NOT NULL COMMENT '授课教师ID,标识学生跟随哪个老师上这门课',
  `join_method` VARCHAR(20) NOT NULL COMMENT '加入方式: ADMIN_ASSIGN-管理员分配, INVITE_CODE-邀请码加入',
  `join_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_student_course_teacher` (`student_id`, `course_id`, `teacher_id`),
  KEY `idx_student_id` (`student_id`),
  KEY `idx_course_id` (`course_id`),
  KEY `idx_teacher_id` (`teacher_id`),
  KEY `idx_join_method` (`join_method`),
  CONSTRAINT `fk_sc_student` FOREIGN KEY (`student_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_sc_course` FOREIGN KEY (`course_id`) REFERENCES `course` (`course_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_sc_teacher` FOREIGN KEY (`teacher_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='学生选课关系表';
```

**字段说明**:
- `student_id`: 学生用户ID
- `course_id`: 课程ID
- `teacher_id`: **授课教师ID，明确学生是跟随哪个教师上这门课**
- `join_method`: 记录学生是通过管理员分配还是邀请码加入
- `join_time`: 加入课程的时间
- 唯一约束调整为 `(student_id, course_id, teacher_id)`，允许学生跟不同老师上同一门课（如重修等场景）

**业务说明**:
- 一个学生可以跟多个老师上同一门课程（如换班、重修等场景）
- 学生通过邀请码加入时，邀请码关联到具体教师，自动记录 `teacher_id`
- 管理员分配时需要指定学生、课程和授课教师

---

### 3.5 学习资源表 (resource)
存储学习资料信息

```sql
CREATE TABLE `resource` (
  `resource_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '资源ID,主键',
  `resource_title` VARCHAR(200) NOT NULL COMMENT '资源标题',
  `description` TEXT DEFAULT NULL COMMENT '资源描述',
  `course_id` BIGINT NOT NULL COMMENT '所属课程ID',
  `uploader_id` BIGINT NOT NULL COMMENT '上传者ID',
  `file_name` VARCHAR(255) NOT NULL COMMENT '文件名称',
  `file_path` VARCHAR(500) NOT NULL COMMENT '文件存储路径',
  `file_size` BIGINT NOT NULL COMMENT '文件大小(字节)',
  `file_type` VARCHAR(50) NOT NULL COMMENT '文件类型: PDF, WORD, EXCEL, PPT, IMAGE, VIDEO, ZIP等',
  `visibility` VARCHAR(20) NOT NULL DEFAULT 'PUBLIC' COMMENT '可见性: PUBLIC-全部学生, COURSE_ONLY-仅本课程学生',
  `download_count` INT NOT NULL DEFAULT 0 COMMENT '下载次数',
  `view_count` INT NOT NULL DEFAULT 0 COMMENT '浏览次数',
  `is_top` TINYINT NOT NULL DEFAULT 0 COMMENT '是否置顶: 0-否, 1-是(仅教师可设置)',
  `tags` VARCHAR(255) DEFAULT NULL COMMENT '资源标签,逗号分隔',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-已下架, 1-正常',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`resource_id`),
  KEY `idx_course_id` (`course_id`),
  KEY `idx_uploader_id` (`uploader_id`),
  KEY `idx_visibility` (`visibility`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_download_count` (`download_count`),
  FULLTEXT KEY `ft_title_desc` (`resource_title`, `description`) COMMENT '全文索引',
  CONSTRAINT `fk_resource_course` FOREIGN KEY (`course_id`) REFERENCES `course` (`course_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_resource_uploader` FOREIGN KEY (`uploader_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='学习资源表';
```

**字段说明**:
- `resource_id`: 资源唯一标识
- `resource_title`: 资源标题
- `course_id`: 所属课程,必填
- `uploader_id`: 上传者(教师或学生)
- `file_path`: 文件存储路径(本地或OSS)
- `visibility`: 可见性控制,教师可设置为仅课程内可见
- `is_top`: 教师可将重要资源置顶
- `tags`: 资源标签,便于分类和搜索
- 全文索引用于标题和描述的快速搜索

**可见性控制逻辑（基于教师维度）**:
- `PUBLIC`: 所有学生都可见（跨教师、跨课程）
- `COURSE_ONLY`: 只有"跟随该教师"上该课程的学生可见
  - 通过 `student_course` 表关联查询
  - 关键条件: `sc.teacher_id = r.uploader_id`（学生的授课教师 = 资源上传者）
  - 即使学生选修了该课程，但如果跟随的是其他教师，也无法看到此资源

**重要说明**:
- 资源访问权限与问答权限不同
- **资源访问**: 需要选课关系（COURSE_ONLY 资源只有选修该教师课程的学生可见）
- **问答功能**: 开放式提问（任何学生都可以向任何教师提问，无需选修）

---

### 3.6 问题表 (question)
存储学生向具体教师提问的信息

```sql
CREATE TABLE `question` (
  `question_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '问题ID,主键',
  `course_id` BIGINT NOT NULL COMMENT '所属课程ID',
  `student_id` BIGINT NOT NULL COMMENT '提问学生ID',
  `teacher_id` BIGINT NOT NULL COMMENT '被提问的教师ID,学生向该教师提问',
  `question_title` VARCHAR(200) NOT NULL COMMENT '问题标题',
  `question_content` TEXT NOT NULL COMMENT '问题内容',
  `image_urls` TEXT DEFAULT NULL COMMENT '图片附件URL,多个用逗号分隔',
  `tags` VARCHAR(255) DEFAULT NULL COMMENT '问题标签,逗号分隔',
  `view_count` INT NOT NULL DEFAULT 0 COMMENT '浏览次数',
  `answer_count` INT NOT NULL DEFAULT 0 COMMENT '回答数量',
  `is_answered` TINYINT NOT NULL DEFAULT 0 COMMENT '是否已回答: 0-未回答, 1-已回答',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-已关闭, 1-正常',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '提问时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`question_id`),
  KEY `idx_course_id` (`course_id`),
  KEY `idx_student_id` (`student_id`),
  KEY `idx_teacher_id` (`teacher_id`),
  KEY `idx_is_answered` (`is_answered`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_course_teacher` (`course_id`, `teacher_id`),
  FULLTEXT KEY `ft_title_content` (`question_title`, `question_content`) COMMENT '全文索引',
  CONSTRAINT `fk_question_course` FOREIGN KEY (`course_id`) REFERENCES `course` (`course_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_question_student` FOREIGN KEY (`student_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_question_teacher` FOREIGN KEY (`teacher_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='问题表';
```

**字段说明**:
- `question_id`: 问题唯一标识
- `course_id`: 问题所属课程
- `student_id`: 提问学生
- `teacher_id`: **被提问的教师ID，明确学生向哪个教师提问**
- `image_urls`: 图片附件,支持多张图片
- `answer_count`: 回答数量,冗余字段,提升查询性能
- `is_answered`: 是否有教师回答,用于筛选未回答问题
- 全文索引用于问题搜索
- 组合索引 `(course_id, teacher_id)` 优化教师查询自己课程下的问题

**业务说明**:
- **开放式提问**: 所有学生都可以向任何教师提问，无需选修该课程
- 学生提问时选择课程和该课程的具体教师
- 教师只能看到和回答向自己提问的问题
- 支持跨课程、跨专业的知识交流和学习

---

### 3.7 回答表 (answer)
存储教师回答信息

```sql
CREATE TABLE `answer` (
  `answer_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '回答ID,主键',
  `question_id` BIGINT NOT NULL COMMENT '问题ID',
  `teacher_id` BIGINT NOT NULL COMMENT '回答教师ID',
  `answer_content` TEXT NOT NULL COMMENT '回答内容',
  `image_urls` TEXT DEFAULT NULL COMMENT '图片附件URL,多个用逗号分隔',
  `like_count` INT NOT NULL DEFAULT 0 COMMENT '点赞数(可选功能)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '回答时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`answer_id`),
  KEY `idx_question_id` (`question_id`),
  KEY `idx_teacher_id` (`teacher_id`),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_answer_question` FOREIGN KEY (`question_id`) REFERENCES `question` (`question_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_answer_teacher` FOREIGN KEY (`teacher_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='回答表';
```

**字段说明**:
- `answer_id`: 回答唯一标识
- `question_id`: 关联的问题
- `teacher_id`: 回答的教师（通常应该与 `question.teacher_id` 一致）
- `image_urls`: 支持图片附件
- `like_count`: 点赞数,可选功能

**业务约束**:
- 教师只能回答向自己提问的问题（`answer.teacher_id = question.teacher_id`）
- 前端/后端应验证：回答者必须是问题的目标教师

---

### 3.8 通知表 (notification)
存储系统通知信息

```sql
CREATE TABLE `notification` (
  `notification_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '通知ID,主键',
  `user_id` BIGINT NOT NULL COMMENT '接收通知的用户ID',
  `notification_type` VARCHAR(50) NOT NULL COMMENT '通知类型: ANSWER_REPLY-问题被回答, RESOURCE_AUDIT-资源审核, SYSTEM-系统公告',
  `title` VARCHAR(200) NOT NULL COMMENT '通知标题',
  `content` TEXT NOT NULL COMMENT '通知内容',
  `related_id` BIGINT DEFAULT NULL COMMENT '关联ID(如问题ID、资源ID)',
  `related_type` VARCHAR(50) DEFAULT NULL COMMENT '关联类型: QUESTION, RESOURCE, COURSE',
  `is_read` TINYINT NOT NULL DEFAULT 0 COMMENT '是否已读: 0-未读, 1-已读',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `read_time` DATETIME DEFAULT NULL COMMENT '阅读时间',
  PRIMARY KEY (`notification_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_is_read` (`is_read`),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_notification_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='通知表';
```

**字段说明**:
- `notification_id`: 通知唯一标识
- `user_id`: 接收通知的用户
- `notification_type`: 通知类型分类
- `related_id` + `related_type`: 关联业务数据,点击通知可跳转到对应页面
- `is_read`: 未读/已读状态
- `read_time`: 阅读时间,用于统计

---

### 3.9 资源收藏表 (resource_collection) [可选]
存储学生收藏的资源

```sql
CREATE TABLE `resource_collection` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `student_id` BIGINT NOT NULL COMMENT '学生ID',
  `resource_id` BIGINT NOT NULL COMMENT '资源ID',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '收藏时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_student_resource` (`student_id`, `resource_id`),
  KEY `idx_student_id` (`student_id`),
  KEY `idx_resource_id` (`resource_id`),
  CONSTRAINT `fk_rc_student` FOREIGN KEY (`student_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_rc_resource` FOREIGN KEY (`resource_id`) REFERENCES `resource` (`resource_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='资源收藏表';
```

**字段说明**:
- 记录学生收藏的资源
- 唯一约束防止重复收藏

---

### 3.10 系统配置表 (system_config) [可选]
存储系统配置参数

```sql
CREATE TABLE `system_config` (
  `config_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `config_key` VARCHAR(100) NOT NULL COMMENT '配置键',
  `config_value` TEXT NOT NULL COMMENT '配置值',
  `description` VARCHAR(500) DEFAULT NULL COMMENT '配置描述',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`config_id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

**配置示例**:
- `max_file_size`: 最大文件上传大小
- `invite_code_expire_days`: 邀请码默认有效天数
- `notification_keep_days`: 通知保留天数

---

## 四、关键业务查询示例

### 4.1 查询学生可见的资源
```sql
-- 查询学生ID为1可见的所有资源（考虑教师维度）
SELECT DISTINCT r.*
FROM resource r
LEFT JOIN student_course sc ON r.course_id = sc.course_id 
  AND sc.student_id = 1
  AND sc.teacher_id = r.uploader_id  -- 学生选的是该教师的课
WHERE r.is_deleted = 0
  AND r.status = 1
  AND (
    r.visibility = 'PUBLIC'  -- 全部公开资源
    OR (
      r.visibility = 'COURSE_ONLY' 
      AND sc.student_id IS NOT NULL  -- 学生已选该课程
      AND sc.teacher_id = r.uploader_id  -- 且是该学生的授课教师上传的
    )
  )
ORDER BY r.is_top DESC, r.create_time DESC;

-- 业务逻辑说明：
-- 1. 学生可以看到所有 PUBLIC 的资源
-- 2. 对于 COURSE_ONLY 的资源，只能看到"自己授课教师"上传的
-- 3. 即使是同一门课，其他教师上传的 COURSE_ONLY 资源也看不到
```

### 4.2 查询教师待回答的问题
```sql
-- 查询教师ID为2的所有待回答问题（直接查询）
SELECT q.*, u.real_name AS student_name, u.student_id AS student_no, c.course_name
FROM question q
INNER JOIN user u ON q.student_id = u.user_id
INNER JOIN course c ON q.course_id = c.course_id
WHERE q.teacher_id = 2  -- 向该教师提问的问题
  AND q.is_answered = 0
  AND q.is_deleted = 0
  AND q.status = 1
ORDER BY q.create_time ASC;

-- 查询教师在某门具体课程下的待回答问题
SELECT q.*, u.real_name AS student_name
FROM question q
INNER JOIN user u ON q.student_id = u.user_id
WHERE q.teacher_id = 2
  AND q.course_id = 1  -- 指定课程
  AND q.is_answered = 0
  AND q.is_deleted = 0
ORDER BY q.create_time ASC;
```

### 4.3 查询课程的所有选课学生
```sql
-- 查询课程ID为3的所有学生（按教师分组）
SELECT u.*, sc.teacher_id, t.real_name AS teacher_name, sc.join_method, sc.join_time
FROM user u
INNER JOIN student_course sc ON u.user_id = sc.student_id
INNER JOIN user t ON sc.teacher_id = t.user_id
WHERE sc.course_id = 3
  AND u.is_deleted = 0
  AND u.status = 1
ORDER BY sc.teacher_id, sc.join_time DESC;

-- 查询某个教师在某门课程下的学生
SELECT u.*, sc.join_method, sc.join_time
FROM user u
INNER JOIN student_course sc ON u.user_id = sc.student_id
WHERE sc.course_id = 3
  AND sc.teacher_id = 2  -- 指定教师ID
  AND u.is_deleted = 0
  AND u.status = 1
ORDER BY sc.join_time DESC;
```

### 4.4 查询学生未读通知数量
```sql
-- 查询学生ID为1的未读通知数
SELECT COUNT(*) AS unread_count
FROM notification
WHERE user_id = 1
  AND is_read = 0;
```

### 4.6 查询课程的所有授课教师（供学生提问选择）
```sql
-- 查询课程ID为1的所有授课教师（学生提问时选择）
SELECT 
  u.user_id AS teacher_id,
  u.real_name AS teacher_name,
  u.job_title,
  u.profile,
  tc.class_name,
  COUNT(DISTINCT q.question_id) AS question_count,
  COUNT(DISTINCT sc.student_id) AS student_count
FROM teacher_course tc
INNER JOIN user u ON tc.teacher_id = u.user_id
LEFT JOIN question q ON tc.teacher_id = q.teacher_id AND tc.course_id = q.course_id
LEFT JOIN student_course sc ON tc.teacher_id = sc.teacher_id AND tc.course_id = sc.course_id
WHERE tc.course_id = 1
  AND u.is_deleted = 0
  AND u.status = 1
GROUP BY u.user_id, u.real_name, u.job_title, u.profile, tc.class_name
ORDER BY u.real_name;

-- 业务说明：
-- 学生可以看到课程的所有教师，选择向任一教师提问
-- 显示教师信息、已回答问题数、学生数等，帮助学生选择合适的教师
```

### 4.7 查询所有课程及其教师（问答广场）
```sql
-- 查询所有开放的课程及授课教师（供学生浏览和提问）
SELECT 
  c.course_id,
  c.course_name,
  c.college,
  GROUP_CONCAT(DISTINCT u.real_name ORDER BY u.real_name SEPARATOR ', ') AS teachers,
  COUNT(DISTINCT tc.teacher_id) AS teacher_count,
  COUNT(DISTINCT q.question_id) AS question_count
FROM course c
INNER JOIN teacher_course tc ON c.course_id = tc.course_id
INNER JOIN user u ON tc.teacher_id = u.user_id
LEFT JOIN question q ON c.course_id = q.course_id
WHERE c.is_deleted = 0
  AND c.status = 1
  AND u.is_deleted = 0
GROUP BY c.course_id, c.course_name, c.college
ORDER BY c.course_name;

-- 业务说明：
-- 展示所有课程及其教师，学生可以自由选择任何课程的任何教师提问
```

### 4.8 查询学生的所有提问及回答情况
```sql
-- 查询学生ID为1的所有提问及回答情况（我的提问）
SELECT 
  q.question_id,
  q.question_title,
  q.question_content,
  q.image_urls AS question_images,
  q.is_answered,
  q.view_count,
  q.create_time AS question_time,
  c.course_name,
  t.real_name AS teacher_name,
  a.answer_id,
  a.answer_content,
  a.image_urls AS answer_images,
  a.create_time AS answer_time,
  a.like_count
FROM question q
INNER JOIN course c ON q.course_id = c.course_id
INNER JOIN user t ON q.teacher_id = t.user_id
LEFT JOIN answer a ON q.question_id = a.question_id AND a.is_deleted = 0
WHERE q.student_id = 1
  AND q.is_deleted = 0
ORDER BY q.create_time DESC, a.create_time ASC;

-- 业务说明：
-- 1. 查询学生的所有提问
-- 2. 通过 LEFT JOIN 关联回答表，获取每个问题的回答内容
-- 3. 如果问题未被回答，answer_id 等回答字段为 NULL
-- 4. 如果问题有回答，可以看到完整的回答内容、回答时间等信息
```

### 4.9 查询学生被回答的问题（已回答的问题）
```sql
-- 查询学生ID为1的所有已被回答的问题
SELECT 
  q.question_id,
  q.question_title,
  q.question_content,
  q.create_time AS question_time,
  c.course_name,
  t.real_name AS teacher_name,
  a.answer_content,
  a.answer_time,
  a.like_count
FROM question q
INNER JOIN course c ON q.course_id = c.course_id
INNER JOIN user t ON q.teacher_id = t.user_id
INNER JOIN (
  SELECT 
    question_id,
    answer_content,
    image_urls,
    create_time AS answer_time,
    like_count
  FROM answer
  WHERE is_deleted = 0
) a ON q.question_id = a.question_id
WHERE q.student_id = 1
  AND q.is_deleted = 0
  AND q.is_answered = 1
ORDER BY a.answer_time DESC;

-- 业务说明：
-- 1. 只查询已被回答的问题（is_answered = 1）
-- 2. 通过 INNER JOIN 确保只返回有回答的问题
-- 3. 显示问题详情、教师回答、回答时间等完整信息
```

### 4.10 查询学生未被回答的问题
```sql
-- 查询学生ID为1的所有未被回答的问题
SELECT 
  q.question_id,
  q.question_title,
  q.question_content,
  q.create_time AS question_time,
  c.course_name,
  t.real_name AS teacher_name,
  DATEDIFF(NOW(), q.create_time) AS days_waiting
FROM question q
INNER JOIN course c ON q.course_id = c.course_id
INNER JOIN user t ON q.teacher_id = t.user_id
WHERE q.student_id = 1
  AND q.is_deleted = 0
  AND q.is_answered = 0
ORDER BY q.create_time DESC;

-- 业务说明：
-- 查询学生的待回答问题，显示等待天数
```

### 4.5 使用邀请码加入课程
```sql
-- 学生通过邀请码加入课程（自动关联到对应教师）
INSERT INTO student_course (student_id, course_id, teacher_id, join_method)
SELECT 1, tc.course_id, tc.teacher_id, 'INVITE_CODE'
FROM teacher_course tc
INNER JOIN course c ON tc.course_id = c.course_id
WHERE tc.invite_code = 'ABC123'  -- 邀请码在 teacher_course 表中
  AND tc.invite_code_expire_time > NOW()
  AND c.status = 1
  AND NOT EXISTS (
    SELECT 1 FROM student_course 
    WHERE student_id = 1 
      AND course_id = tc.course_id 
      AND teacher_id = tc.teacher_id  -- 防止重复加入同一教师的同一课程
  );

-- 业务说明：
-- 1. 邀请码存储在 teacher_course 表，关联到具体的"教师-课程"
-- 2. 学生使用邀请码后，自动记录是跟随哪个教师上课
-- 3. 同一学生可以使用不同教师的邀请码加入同一门课程（如换班、重修）
```

---

## 五、数据库初始化脚本

### 5.1 创建数据库
```sql
CREATE DATABASE IF NOT EXISTS `learning_system` 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE `learning_system`;
```

### 5.2 初始化管理员账号
```sql
-- 插入默认管理员账号 (密码: admin123, BCrypt加密后的值)
INSERT INTO `user` (
  `username`, 
  `password`, 
  `real_name`, 
  `email`, 
  `role`, 
  `status`
) VALUES (
  'admin',
  '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi',  -- admin123
  '系统管理员',
  'admin@example.com',
  'ADMIN',
  1
);
```

### 5.3 插入测试数据(可选)
```sql
-- 插入测试教师
INSERT INTO `user` (username, password, real_name, email, role, job_title, profile) VALUES
('teacher1', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '张老师', 'teacher1@example.com', 'TEACHER', '教授', '计算机科学专业教授'),
('teacher2', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '李老师', 'teacher2@example.com', 'TEACHER', '副教授', '数据结构与算法讲师');

-- 插入测试学生
INSERT INTO `user` (username, password, real_name, email, role, student_id, college) VALUES
('student1', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '王同学', 'student1@example.com', 'STUDENT', '2021001', '计算机学院'),
('student2', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '刘同学', 'student2@example.com', 'STUDENT', '2021002', '软件学院');

-- 插入测试课程
INSERT INTO `course` (course_name, course_code, description, college) VALUES
('数据结构与算法', 'CS101', '讲授基本数据结构与算法设计', '计算机学院'),
('Java程序设计', 'CS102', 'Java语言基础与面向对象编程', '软件学院');

-- 分配教师到课程，并生成邀请码
INSERT INTO `teacher_course` (teacher_id, course_id, invite_code, invite_code_expire_time, class_name) VALUES
(2, 1, 'CS101_ZHANG', DATE_ADD(NOW(), INTERVAL 30 DAY), '2024级1班'),  -- 张老师教授数据结构
(3, 2, 'CS102_LI', DATE_ADD(NOW(), INTERVAL 30 DAY), '2024级软件班');  -- 李老师教授Java

-- 学生选课（指定跟随的教师）
INSERT INTO `student_course` (student_id, course_id, teacher_id, join_method) VALUES
(4, 1, 2, 'ADMIN_ASSIGN'),  -- 王同学选数据结构，跟随张老师(管理员分配)
(5, 2, 3, 'INVITE_CODE');   -- 刘同学选Java，跟随李老师(邀请码加入)
```

---

## 六、索引优化建议

### 6.1 已建立的索引
- 主键索引: 所有表的主键自动创建聚簇索引
- 唯一索引: 用户名、邮箱、学号、课程邀请码等
- 外键索引: 所有外键字段自动建立索引
- 普通索引: 常用查询字段(角色、状态、时间等)
- 全文索引: 资源标题/描述、问题标题/内容

### 6.2 性能优化建议
1. **分页查询优化**: 使用延迟关联优化深分页
2. **避免SELECT ***: 明确指定需要的字段
3. **合理使用覆盖索引**: 避免回表查询
4. **定期分析慢查询**: 使用EXPLAIN分析执行计划
5. **合理设置缓存**: 对热点数据进行Redis缓存

---

## 七、数据库扩展建议

### 7.1 可选扩展表

#### 7.1.1 操作日志表 (operation_log)
记录用户重要操作,便于审计和问题追踪

```sql
CREATE TABLE `operation_log` (
  `log_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` BIGINT NOT NULL COMMENT '操作用户ID',
  `operation_type` VARCHAR(50) NOT NULL COMMENT '操作类型',
  `operation_desc` VARCHAR(500) DEFAULT NULL COMMENT '操作描述',
  `request_method` VARCHAR(10) DEFAULT NULL COMMENT '请求方法: GET, POST等',
  `request_url` VARCHAR(500) DEFAULT NULL COMMENT '请求URL',
  `request_params` TEXT DEFAULT NULL COMMENT '请求参数',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT 'IP地址',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`log_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

#### 7.1.2 问题点赞表 (answer_like)
记录学生对回答的点赞

```sql
CREATE TABLE `answer_like` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `answer_id` BIGINT NOT NULL COMMENT '回答ID',
  `user_id` BIGINT NOT NULL COMMENT '点赞用户ID',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '点赞时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_answer_user` (`answer_id`, `user_id`),
  CONSTRAINT `fk_like_answer` FOREIGN KEY (`answer_id`) REFERENCES `answer` (`answer_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_like_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='回答点赞表';
```

### 7.2 分表建议
当数据量增长到一定程度时,可考虑以下分表策略:
- **通知表**: 按月分表 (`notification_202401`, `notification_202402`...)
- **操作日志表**: 按月或按季度分表
- **资源表**: 按年分表(如果资源量非常大)

---

## 八、ER图关系说明

### 8.1 核心实体关系
```
用户(User) 1---N 学生选课(StudentCourse) N---1 课程(Course)
              1---N 教师授课(TeacherCourse) N---1

用户(User) 1---N 资源(Resource) N---1 课程(Course)
          1---N 问题(Question) N---1 课程(Course)
          1---N 回答(Answer) N---1 问题(Question)
          1---N 通知(Notification)
          1---N 资源收藏(ResourceCollection) N---1 资源(Resource)
```

### 8.2 关系说明
- **用户-课程**: 通过 `student_course` 和 `teacher_course` 两个中间表建立多对多关系
- **资源-课程**: 多对一关系,一个资源属于一门课程
- **问题-课程**: 多对一关系,问题在课程下提出
- **回答-问题**: 多对一关系,一个问题可有多个回答
- **通知-用户**: 多对一关系,通知发送给特定用户

---

## 九、数据安全与备份

### 9.1 数据备份策略
- **全量备份**: 每周一次全量备份
- **增量备份**: 每天一次增量备份
- **binlog备份**: 实时binlog备份,用于数据恢复

### 9.2 数据安全措施
- 密码使用BCrypt加密存储,不可逆
- 敏感字段(如邮箱、手机号)可考虑加密存储
- 定期清理软删除的数据
- 重要操作记录审计日志
- 数据库访问权限严格控制

### 9.3 数据清理策略
- 软删除数据保留30天后物理删除
- 已读通知保留90天后删除
- 操作日志保留6个月

---

## 十、总结

本数据库设计方案完整实现了大学生线上学习资源共享与问答系统的所有功能需求:

### 10.1 核心特性
✅ 支持三种角色(管理员、教师、学生)的权限管理  
✅ 实现学生通过邀请码或管理员分配加入课程  
✅ 资源可见性控制(基于教师维度：PUBLIC/COURSE_ONLY)  
✅ **开放式问答系统**：所有学生可向任何教师提问，无需选修限制  
✅ 完整的问答流程(提问-回答-通知)  
✅ 通知系统支持多种通知类型  
✅ 软删除机制保护历史数据  
✅ 全文索引支持高效搜索  
✅ 外键约束保证数据完整性  

### 10.2 扩展性
- 支持后续添加班级维度的资源可见性控制
- 支持添加评论、点赞等社交功能
- 支持添加在线考试、作业提交等教学功能
- 预留了系统配置表,便于动态调整参数

### 10.3 性能优化
- 合理的索引设计提升查询性能
- 冗余字段(如下载次数、回答数)减少JOIN查询
- 全文索引支持快速搜索
- 分表策略应对大数据量场景

本设计方案字段命名规范、见名知意,符合企业级开发标准,可直接用于项目开发。
