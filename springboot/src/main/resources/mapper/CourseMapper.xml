<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boda.springboot.mapper.CourseMapper">

    <!-- 动态插入课程信息 -->
    <insert id="save"
            parameterType="com.boda.springboot.entity.Course"
            useGeneratedKeys="true"
            keyProperty="courseId">
        INSERT INTO course (
            course_name,
            course_code,
            college
            <if test="description != null">, description</if>
            <if test="coverImage != null">, cover_image</if>
            <if test="status != null">, status</if>
            <if test="createTime != null">, create_time</if>
            <if test="updateTime != null">, update_time</if>
            <if test="isDeleted != null">, is_deleted</if>
        )
        VALUES (
            #{courseName},
            #{courseCode},
            #{college}
            <if test="description != null">, #{description}</if>
            <if test="coverImage != null">, #{coverImage}</if>
            <if test="status != null">, #{status}</if>
            <if test="createTime != null">, #{createTime}</if>
            <if test="updateTime != null">, #{updateTime}</if>
            <if test="isDeleted != null">, #{isDeleted}</if>
        )
    </insert>

    <!-- 分页查询课程列表 -->
    <select id="pageQuery" resultType="com.boda.springboot.entity.Course">
        SELECT
            c.course_id,
            c.course_name,
            c.course_code,
            c.description,
            c.college,
            c.cover_image,
            c.status,
            c.create_time,
            GROUP_CONCAT(u.real_name SEPARATOR ', ') as teacherName
        FROM course c
        LEFT JOIN teacher_course tc ON c.course_id = tc.course_id
        LEFT JOIN user u ON tc.teacher_id = u.user_id
        WHERE c.is_deleted = 0
        <if test="status != null">
            AND c.status = #{status}
        </if>
        <if test="courseName != null and courseName != ''">
            AND c.course_name LIKE CONCAT('%', #{courseName}, '%')
        </if>
        <if test="courseCode != null and courseCode != ''">
            AND c.course_code LIKE CONCAT('%', #{courseCode}, '%')
        </if>
        <if test="college != null and college != ''">
            AND c.college LIKE CONCAT('%', #{college}, '%')
        </if>
        GROUP BY c.course_id
        ORDER BY c.create_time DESC
    </select>

    <!-- 动态更新课程信息 -->
    <update id="update" parameterType="com.boda.springboot.entity.Course">
        UPDATE course
        <set>
            <if test="courseName != null and courseName != ''">course_name = #{courseName},</if>
            <if test="courseCode != null and courseCode != ''">course_code = #{courseCode},</if>
            <if test="description != null">description = #{description},</if>
            <if test="college != null and college != ''">college = #{college},</if>
            <if test="coverImage != null">cover_image = #{coverImage},</if>
            <if test="status != null">status = #{status},</if>
            update_time = NOW()
        </set>
        WHERE course_id = #{courseId}
        AND is_deleted = 0
    </update>

    <!-- 查询教师的课程列表 -->
    <select id="selectByTeacherId" resultType="com.boda.springboot.vo.CourseVO">
        SELECT
            c.course_id,
            c.course_name,
            c.course_code,
            c.description,
            c.college,
            c.cover_image,
            tc.invite_code,
            c.status,
            c.create_time,
            (SELECT COUNT(*) FROM student_course sc WHERE sc.course_id = c.course_id) as studentCount
        FROM course c
        INNER JOIN teacher_course tc ON c.course_id = tc.course_id
        WHERE tc.teacher_id = #{teacherId}
          AND c.is_deleted = 0
        ORDER BY c.create_time DESC
    </select>

    <!-- 删除课程（逻辑删除） -->
    <update id="deleteById">
        UPDATE course
        SET is_deleted = 1, update_time = NOW()
        WHERE course_id = #{courseId}
    </update>

    <!-- 查询课程的学生列表 -->
    <select id="selectStudentsByCourseId" resultType="com.boda.springboot.entity.User">
        SELECT
            u.user_id,
            u.username,
            u.real_name,
            u.student_id,
            u.college,
            u.email,
            u.phone,
            u.avatar_url,
            u.create_time
        FROM user u
        INNER JOIN student_course sc ON u.user_id = sc.student_id
        WHERE sc.course_id = #{courseId}
          AND u.is_deleted = 0
        ORDER BY sc.create_time DESC
    </select>

    <!-- 查询课程的教师列表 -->
    <select id="selectTeachersByCourseId" resultType="com.boda.springboot.entity.User">
        SELECT
            u.user_id,
            u.username,
            u.real_name,
            u.phone,
            u.email,
            u.college,
            u.job_title,
            u.avatar_url
        FROM user u
        INNER JOIN teacher_course tc ON u.user_id = tc.teacher_id
        WHERE tc.course_id = #{courseId}
          AND u.is_deleted = 0
    </select>

    <!-- 热门课程：按选课学生数降序 -->
    <select id="selectHotCourses" resultType="com.boda.springboot.vo.HotCourseVO">
        SELECT
            c.course_id AS courseId,
            c.course_name AS courseName,
            c.college,
            c.cover_image AS coverImage,
            COUNT(sc.student_id) AS studentCount
        FROM course c
        LEFT JOIN student_course sc ON c.course_id = sc.course_id
        WHERE c.is_deleted = 0
        GROUP BY c.course_id, c.course_name, c.college, c.cover_image
        ORDER BY studentCount DESC, c.create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 查询学生的课程列表 -->
    <select id="selectByStudentId" resultType="com.boda.springboot.entity.Course">
        SELECT
            c.course_id,
            c.course_name,
            c.course_code,
            c.description,
            c.college,
            c.cover_image,
            c.status,
            c.create_time,
            u.real_name as teacherName
        FROM course c
        INNER JOIN student_course sc ON c.course_id = sc.course_id
        LEFT JOIN user u ON sc.teacher_id = u.user_id
        WHERE sc.student_id = #{studentId}
          AND c.is_deleted = 0
        ORDER BY sc.create_time DESC
    </select>

</mapper>